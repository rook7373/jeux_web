<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Tic-Tac-Toe Arena - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Yams_multi theme */
        body { background: radial-gradient(circle at center, #0a2f1a 0%, #000000 100%); color: white; min-height: 100vh; overflow-x: hidden; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        
        #board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; width: 100%; max-width: 400px; }
        .cell { 
            background-color: rgba(0,0,0,0.4); 
            border-radius: 1.5rem; 
            aspect-ratio: 1 / 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 5rem; 
            font-weight: 900; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.5); 
        }
        .cell:hover { background-color: rgba(255,255,255,0.1); transform: scale(1.05); }

        .cell.X { color: #60a5fa; text-shadow: 0 0 20px #60a5fa; } /* blue-400 */
        .cell.O { color: #f87171; text-shadow: 0 0 20px #f87171; } /* red-400 */

        .winning-cell { animation: pulse-win 1.2s infinite; }
        @keyframes pulse-win { 
            0% { background-color: rgba(29, 255, 175, 0.4); } 
            50% { background-color: rgba(0,0,0,0.4); } 
            100% { background-color: rgba(29, 255, 175, 0.4); } 
        }
        input::placeholder { color: #9ca3af; }
    </style>
</head>
<body class="p-4 flex items-center justify-center font-sans uppercase font-black">

    <div id="setup" class="max-w-md w-full bg-white p-8 md:p-12 rounded-[3.5rem] shadow-2xl text-slate-900 z-50">
        <h2 id="setup-title" class="text-4xl font-black mb-8 text-green-900 text-center italic tracking-tighter uppercase">TIC-TAC-TOE ARENA</h2>
        
        <div id="mode-selector" class="grid grid-cols-2 gap-4 mb-8">
            <button type="button" onclick="setMode('local')" id="m-local" class="bg-green-600 text-white py-4 rounded-2xl shadow-lg transition font-black">LOCAL</button>
            <button type="button" onclick="setMode('remote')" id="m-remote" class="bg-slate-200 text-slate-500 py-4 rounded-2xl transition font-black">EN LIGNE</button>
        </div>

        <div class="space-y-6">
            <input type="text" id="my-name-in" onkeydown="if(event.key === 'Enter') startAction()" placeholder="TON PSEUDO..." class="w-full bg-slate-100 p-5 rounded-3xl outline-none text-xl text-center focus:border-green-400 font-black uppercase shadow-inner">
            
            <button onclick="startAction()" class="w-full bg-black text-white py-7 rounded-3xl text-2xl shadow-xl active:scale-95 transition-all font-black">DÉMARRER</button>
            <a href="index.html" class="block w-full text-center text-slate-400 text-[10px] tracking-widest uppercase font-black py-2">RETOUR HUB</a>
        </div>
    </div>

    <div id="game" class="hidden relative max-w-2xl w-full bg-black/40 backdrop-blur-xl p-6 md:p-8 rounded-[3.5rem] border-4 border-white/5">
        <div class="flex justify-between items-center mb-8">
            <a href="index.html" class="text-[10px] bg-white/10 px-6 py-3 rounded-full hover:bg-white/20 transition font-black">MENU</a>
            <div id="players-display" class="flex gap-4 md:gap-8 text-sm md:text-base tracking-widest items-center font-black"></div>
            <button onclick="copyLink()" id="btn-copy" class="hidden bg-green-600 text-white text-[10px] px-4 py-2 rounded-full tracking-widest shadow-lg active:scale-90 transition-all font-black uppercase">LIEN</button>
        </div>
        <div class="flex justify-center mb-6"><div id="board"></div></div>
        <div id="win-overlay" class="hidden text-center backdrop-blur-sm bg-black/50 absolute inset-0 m-4 md:m-8 rounded-[3rem] flex flex-col items-center justify-center">
            <p id="win-text" class="text-5xl text-yellow-400 mb-8 italic tracking-tighter"></p>
            <div class="flex gap-4">
                <button onclick="location.reload()" class="bg-white/20 text-white px-10 py-4 rounded-full text-sm font-black shadow-xl hover:bg-white/30 transition uppercase">Rejouer</button>
                <button onclick="saveAndReset()" class="bg-white text-black px-10 py-4 rounded-full text-sm font-black shadow-xl hover:scale-105 transition uppercase">Accueil</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'api_tictactoe.php';
        let roomId = new URLSearchParams(window.location.search).get('room');
        let myName = '', myMark = 'X', gameMode = roomId ? 'remote' : 'local';
        let gameState = { players: [], board: Array(9).fill(null), currentPlayer: 'X', gameOver: false, winner: null, winningLine: [] };

        window.onload = () => {
            if(roomId) {
                document.getElementById('mode-selector').classList.add('hidden');
                document.getElementById('setup-title').innerHTML = "REJOINDRE <span class='text-slate-200'>ARENA</span>";
                gameMode = 'remote';
            } else {
                setMode('local');
            }
        };

        function setMode(m) { 
            gameMode = m; 
            document.getElementById('m-local').className = (m === 'local') ? "bg-green-600 text-white py-4 rounded-2xl shadow-lg font-black" : "bg-slate-200 text-slate-500 py-4 rounded-2xl font-black";
            document.getElementById('m-remote').className = (m === 'remote') ? "bg-green-600 text-white py-4 rounded-2xl shadow-lg font-black" : "bg-slate-200 text-slate-500 py-4 rounded-2xl font-black";
        }

        async function startAction() {
            const name = document.getElementById('my-name-in').value.trim();
            if(!name) return alert("Pseudo !"); myName = name.toUpperCase();
            
            if (gameMode === 'remote') {
                if (!roomId) roomId = Math.random().toString(36).substring(2, 8);
                window.history.pushState({}, '', `?room=${roomId}`);
                await syncPull();
                if (gameState.players.length === 1) {
                    myMark = 'O';
                }
                if (!gameState.players.find(p => p.name === myName)) {
                    if (gameState.players.length < 2) {
                        gameState.players.push({ name: myName, mark: myMark });
                    } else return alert("Plein !");
                } setInterval(syncPull, 2000);
            } else {
                gameState.players = [{ name: myName, mark: 'X' }, { name: 'JOUEUR 2', mark: 'O' }];
            }
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            if(gameMode === 'remote') { document.getElementById('btn-copy').classList.remove('hidden'); await syncPush(); }
            render();
        }

        async function syncPush() { if(roomId) await fetch(`${API}?action=sync&roomId=${roomId}`, { method: 'POST', body: JSON.stringify(gameState) }); }
        
        async function syncPull() {
            if(!roomId) return;
            try { 
                const r = await fetch(`${API}?action=sync&roomId=${roomId}&t=${Date.now()}`); 
                const data = await r.json(); 
                if (data) { 
                    const isGameOver = gameState.gameOver;
                    gameState = data; 
                    if(isGameOver !== gameState.gameOver) {
                         document.getElementById('win-overlay').classList.toggle('hidden', !gameState.gameOver);
                    }
                    render();
                } 
            } catch(e) {}
        }

        function handleMove(index) {
            if (gameState.gameOver || gameState.board[index] || (gameMode === 'remote' && (gameState.players.length < 2 || gameState.currentPlayer !== myMark))) return;
            
            gameState.board[index] = gameState.currentPlayer;
            
            if (checkWin()) {
                gameState.gameOver = true;
                gameState.winner = gameState.players.find(p => p.mark === gameState.currentPlayer).name;
            } else if (gameState.board.every(cell => cell)) {
                gameState.gameOver = true;
                gameState.winner = "Personne"; // Draw
            } else {
                gameState.currentPlayer = gameState.currentPlayer === 'X' ? 'O' : 'X';
            }
            if(gameMode === 'remote') syncPush(); 
            render();
        }

        function checkWin() {
            const lines = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            for (let line of lines) {
                const [a, b, c] = line;
                if (gameState.board[a] && gameState.board[a] === gameState.board[b] && gameState.board[a] === gameState.board[c]) {
                    gameState.winningLine = line;
                    return true;
                }
            }
            return false;
        }

        function render() {
            const b = document.getElementById('board'); b.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = `cell ${gameState.board[i] || ''}`;
                if (gameState.winningLine.includes(i) && gameState.gameOver) {
                    cell.classList.add('winning-cell');
                }
                cell.innerText = gameState.board[i] || '';
                cell.onclick = () => handleMove(i);
                b.appendChild(cell);
            }
            const p1 = gameState.players.find(p => p.mark === 'X') || { name: '...', mark: 'X' };
            const p2 = gameState.players.find(p => p.mark === 'O') || { name: '...', mark: 'O' };
            document.getElementById('players-display').innerHTML = `
                <span class="${gameState.currentPlayer === p1.mark ? 'ring-2 ring-white/30 bg-white/10' : 'opacity-40'} px-4 py-2 rounded-2xl" style="color:#60a5fa; text-shadow: 0 0 10px #60a5fa;">${p1.name} (X)</span>
                <span class="text-slate-600 font-bold italic">VS</span>
                <span class="${gameState.currentPlayer === p2.mark ? 'ring-2 ring-white/30 bg-white/10' : 'opacity-40'} px-4 py-2 rounded-2xl" style="color:#f87171; text-shadow: 0 0 10px #f87171;">${p2.name} (O)</span>
            `;
            if (gameState.gameOver) { 
                document.getElementById('win-overlay').classList.remove('hidden'); 
                document.getElementById('win-text').innerText = gameState.winner === "Personne" ? "ÉGALITÉ !" : `${gameState.winner} GAGNE !`;
            } else {
                document.getElementById('win-overlay').classList.add('hidden');
            }
        }

        async function saveAndReset() {
            if (gameMode === 'local') { window.location.href='index.html'; return; }
            const gameData = { game: "Tic-Tac-Toe", date: new Date().toLocaleDateString('fr-FR'), winner: gameState.winner };
            try { 
                await fetch(`${API}?action=stats`, { method: 'POST', body: JSON.stringify(gameData) }); 
            } catch (e) { console.error("Save failed:", e); }
            finally { window.location.href = 'index.html'; }
        }
        function copyLink() { navigator.clipboard.writeText(window.location.href); alert("LIEN COPIÉ !"); }
    </script>
</body>
</html>
