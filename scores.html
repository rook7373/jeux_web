<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palmar√®s & Records - ScoreMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans p-4">

    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-10 mt-6">
            <h1 class="text-4xl font-black text-gray-800 tracking-tighter uppercase italic">üèÜ Palmar√®s <span class="text-blue-600">Global</span></h1>
            <a href="index.html" class="bg-white text-gray-600 px-6 py-3 rounded-2xl shadow-sm font-bold border hover:bg-gray-50 transition">Retour au Hub</a>
        </div>

        <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            </div>

        <div class="mt-12 bg-white rounded-[2.5rem] p-8 shadow-xl border">
            <h2 class="text-2xl font-black text-gray-700 mb-6 uppercase italic">Historique des parties</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs font-black text-gray-400 uppercase tracking-widest border-b">
                            <th class="p-4">Date</th>
                            <th class="p-4">Jeu</th>
                            <th class="p-4">Gagnant</th>
                            <th class="p-4">Score</th>
                        </tr>
                    </thead>
                    <tbody id="history-table">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function loadAllStats() {
            try {
                const response = await fetch('api.php?action=stats');
                const history = await response.json();
                if (!history || history.length === 0) {
                    document.getElementById('stats-grid').innerHTML = "<p class='text-gray-400 font-bold'>Aucune donn√©e enregistr√©e pour le moment.</p>";
                    return;
                }

                const statsGrid = document.getElementById('stats-grid');
                const historyTable = document.getElementById('history-table');

                // 1. G√©rer l'Historique (10 derni√®res parties)
                const lastGames = [...history].reverse().slice(0, 10);
                historyTable.innerHTML = lastGames.map(game => `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="p-4 text-sm font-medium text-gray-500">${game.date || 'N/A'}</td>
                        <td class="p-4 font-bold text-gray-800 uppercase text-xs">${game.game}</td>
                        <td class="p-4"><span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black uppercase">${game.winner}</span></td>
                        <td class="p-4 font-black text-gray-700 text-sm">${game.results.find(r => r.name === game.winner).score}</td>
                    </tr>
                `).join('');

                // 2. G√©rer les Records par Jeu
                const gameTypes = [...new Set(history.map(h => h.game))];
                
                gameTypes.forEach(gameName => {
                    let playerStats = {};
                    history.filter(h => h.game === gameName).forEach(entry => {
                        entry.results.forEach(res => {
                            if (!playerStats[res.name]) playerStats[res.name] = { wins: 0, best: null };
                            if (entry.winner === res.name) playerStats[res.name].wins++;
                            
                            // Logique du Record (Min pour Skyjo, Max pour les autres)
                            if (playerStats[res.name].best === null) {
                                playerStats[res.name].best = res.score;
                            } else {
                                if (gameName.toLowerCase().includes('skyjo')) {
                                    playerStats[res.name].best = Math.min(playerStats[res.name].best, res.score);
                                } else {
                                    playerStats[res.name].best = Math.max(playerStats[res.name].best, res.score);
                                }
                            }
                        });
                    });

                    // Couleur dynamique
                    let color = "text-indigo-600";
                    let bg = "border-indigo-500";
                    if(gameName.toLowerCase().includes('skyjo')) { color = "text-green-600"; bg = "border-green-500"; }
                    if(gameName.toLowerCase().includes('bac')) { color = "text-yellow-600"; bg = "border-yellow-500"; }

                    let cardHtml = `
                        <div class="bg-white rounded-[2.5rem] p-8 shadow-xl border-l-[12px] ${bg} animate-pop">
                            <h3 class="text-2xl font-black mb-6 uppercase tracking-tighter text-gray-800">${gameName}</h3>
                            <div class="space-y-4">
                                ${Object.entries(playerStats).sort((a,b) => b[1].wins - a[1].wins).map(([name, data]) => `
                                    <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                        <div>
                                            <div class="font-black text-gray-700 uppercase text-xs">${name}</div>
                                            <div class="text-[10px] font-bold text-gray-400 uppercase">Record: ${data.best} pts</div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl font-black ${color}">${data.wins}</span>
                                            <span class="text-[10px] font-black text-gray-400 uppercase">Victoires</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    statsGrid.innerHTML += cardHtml;
                });

            } catch (error) {
                console.error("Erreur de chargement des stats:", error);
            }
        }

        window.onload = loadAllStats;
    </script>
</body>
</html>
