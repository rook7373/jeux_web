<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yam's - ScoreMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4">
    <div id="setup" class="max-w-md mx-auto mt-12 bg-white p-8 rounded-3xl shadow-2xl">
        <h2 class="text-3xl font-black mb-6 text-indigo-600 uppercase italic">Yam's Setup</h2>
        <input type="text" id="p-input" placeholder="Nom..." class="w-full border-2 p-4 rounded-2xl mb-4 outline-none focus:border-indigo-500">
        <div id="chips" class="flex flex-wrap gap-2 mb-6"></div>
        <button onclick="start()" class="w-full bg-black text-white py-4 rounded-2xl font-black uppercase">Lancer</button>
        <a href="index.html" class="block text-center mt-4 text-gray-400 font-bold">Retour</a>
    </div>

    <div id="game" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow border-t-4 border-indigo-600">
            <h2 class="text-2xl font-black text-indigo-600 italic uppercase">Yam's</h2>
            <button onclick="saveAndExit()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm">SAUVER RECORD</button>
        </div>
        <div class="overflow-x-auto bg-white rounded-3xl shadow-xl border">
            <table class="w-full border-collapse">
                <thead id="t-head" class="bg-gray-50 text-xs uppercase text-gray-400"></thead>
                <tbody id="t-body"></tbody>
                <tfoot id="t-foot" class="bg-indigo-900 text-white"></tfoot>
            </table>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full text-center">
            <h3 id="m-title" class="text-3xl font-black mb-6 text-gray-800 uppercase"></h3>
            <div id="m-opts" class="grid grid-cols-3 gap-3"></div>
            <button onclick="closeM()" class="mt-8 text-gray-400 font-bold uppercase text-xs">Annuler</button>
        </div>
    </div>

    <script>
        let players = [];
        let activeLoc = {pi:0, ci:0};
        const cats = [
            {id:0, label:'As (1)', factor:1}, {id:1, label:'Deux (2)', factor:2}, {id:2, label:'Trois (3)', factor:3},
            {id:3, label:'Quatre (4)', factor:4}, {id:4, label:'Cinq (5)', factor:5}, {id:5, label:'Six (6)', factor:6},
            {id:6, label:'BONUS (63+)', type:'auto'},
            {id:7, label:'Brelan', type:'sum'}, {id:8, label:'Carré', type:'sum'}, {id:9, label:'Full', score:25},
            {id:10, label:'P. Suite', score:30}, {id:11, label:'G. Suite', score:40}, {id:12, label:'Yam\'s', score:50}, {id:13, label:'Chance', type:'sum'}
        ];

        function addPlayer() {
            const v = document.getElementById('p-input').value.trim();
            if(v) { players.push({name:v, scores:{}}); document.getElementById('p-input').value=""; renderChips(); }
        }
        document.getElementById('p-input').onkeyup = (e) => e.key === 'Enter' && addPlayer();
        function renderChips() { document.getElementById('chips').innerHTML = players.map(p => `<span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold text-xs uppercase">${p.name}</span>`).join(''); }

        function start() {
            if(players.length === 0) return;
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            let h = `<tr><th class="p-4 text-left">Combinaison</th>`;
            players.forEach(p => h += `<th class="p-4 border-l text-center font-black text-indigo-600">${p.name}</th>`);
            document.getElementById('t-head').innerHTML = h + `</tr>`;
            renderTable();
        }

        function renderTable() {
            let b = "";
            cats.forEach(c => {
                b += `<tr class="${c.type==='auto'?'bg-yellow-50 font-bold':''}">
                    <td class="p-4 border-b text-sm font-bold text-gray-600">${c.label}</td>
                    ${players.map((p,pi) => `<td onclick="openM(${pi},${c.id})" class="p-4 border-b border-l text-center cursor-pointer font-black ${p.scores[c.id]!==undefined?'text-black':'text-gray-200'}">${p.scores[c.id]??'-'}</td>`).join('')}
                </tr>`;
            });
            document.getElementById('t-body').innerHTML = b;
            let f = `<tr><td class="p-4 font-black">TOTAL GÉNÉRAL</td>`;
            players.forEach(p => f += `<td class="p-4 border-l text-center font-black text-2xl">${Object.values(p.scores).reduce((a,b)=>a+b,0)}</td>`);
            document.getElementById('t-foot').innerHTML = f + "</tr>";
        }

        function openM(pi, ci) {
            const c = cats.find(x => x.id === ci); if(c.type === 'auto') return;
            activeLoc = {pi, ci};
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('m-title').innerText = c.label;
            const o = document.getElementById('m-opts'); o.innerHTML = "";
            if(c.factor) {
                for(let i=0; i<=5; i++) o.innerHTML += `<button onclick="saveY(${i*c.factor})" class="bg-slate-100 p-6 rounded-3xl font-black text-2xl">${i}</button>`;
            } else if(c.score) {
                o.innerHTML = `<button onclick="saveY(${c.score})" class="col-span-2 bg-green-500 text-white p-6 rounded-3xl font-black">OUI (${c.score})</button><button onclick="saveY(0)" class="bg-red-500 text-white p-6 rounded-3xl font-bold">NON (0)</button>`;
            } else {
                o.innerHTML = `<div class="col-span-3 space-y-4"><input type="number" id="m-in" class="w-full border-4 p-4 rounded-2xl text-center text-4xl font-black outline-none"><button onclick="saveY(document.getElementById('m-in').value)" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black">VALIDER</button></div>`;
                setTimeout(()=>document.getElementById('m-in').focus(),100);
            }
        }
        function saveY(v) {
            const p = players[activeLoc.pi]; p.scores[activeLoc.ci] = parseInt(v)||0;
            let up = [0,1,2,3,4,5].reduce((s,i)=>s+(p.scores[i]||0),0);
            p.scores[6] = up >= 63 ? 35 : 0;
            closeM(); renderTable();
        }
        function closeM() { document.getElementById('modal').style.display = 'none'; }
        async function saveAndExit() {
            let res = { game: "Yam's", results: players.map(p => ({name:p.name, score: Object.values(p.scores).reduce((a,b)=>a+b,0)})) };
            res.winner = [...res.results].sort((a,b)=>b.score-a.score)[0].name;
            const h = await (await fetch('api.php?action=stats')).json();
            h.push(res);
            await fetch('api.php?action=stats', {method:'POST', body: JSON.stringify(h)});
            location.href='index.html';
        }
    </script>
</body>
</html>
