<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mode Libre - ScoreMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Yams_multi theme */
        body { background: radial-gradient(circle at center, #0a2f1a 0%, #000000 100%); min-height: 100vh; color: white; overflow-x: hidden; font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button { display: none; }
        input::placeholder { color: #9ca3af; }
        
        .score-input:focus { border-color: #16a34a; background: rgba(22, 163, 74, 0.1); }
        .table-row-hover:hover { background: rgba(255,255,255,0.05); }
        
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="p-4 font-sans uppercase font-black">

    <div id="setup" class="bg-white text-slate-900 p-8 md:p-12 rounded-[3.5rem] max-w-md mx-auto shadow-2xl animate-pop">
        <h2 class="text-3xl font-black mb-8 text-green-600 uppercase italic tracking-tighter text-center">Nouveau Jeu Libre</h2>
        
        <div class="space-y-6">
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Nom du jeu</label>
                <input type="text" id="game-name" placeholder="Ex: Belote, Uno, Tarot..." 
                       class="w-full border-2 bg-slate-100 p-4 rounded-2xl outline-none focus:border-green-500 font-bold shadow-inner">
            </div>

            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Ajouter des joueurs</label>
                <div class="flex gap-2">
                    <input type="text" id="p-input" onkeyup="if(event.key === 'Enter') addPlayer()" placeholder="Nom..." 
                           class="flex-1 bg-slate-100 shadow-inner p-4 rounded-2xl outline-none focus:border-green-500 font-black uppercase">
                    <button onclick="addPlayer()" class="bg-green-600 text-white px-6 rounded-2xl font-black shadow-lg hover:bg-green-500 transition-colors">+</button>
                </div>
            </div>

            <div id="chips" class="flex flex-wrap gap-2"></div>

            <div class="grid grid-cols-1 gap-3 pt-4 border-t">
                <button onclick="pickStarter()" class="w-full bg-slate-100 text-gray-500 py-3 rounded-2xl font-bold border-2 border-dashed hover:border-solid hover:border-green-400 uppercase text-xs">üé≤ Qui commence ?</button>
                <button onclick="start()" class="w-full bg-black text-white py-7 rounded-3xl font-black text-2xl shadow-xl active:scale-95 transition-all">Cr√©er la grille</button>
            </div>
        </div>
        <a href="index.html" class="block text-center mt-6 text-gray-300 font-bold uppercase text-[10px] tracking-widest">Retour au Hub</a>
    </div>

    <div id="game" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6 bg-black/40 backdrop-blur-xl p-4 rounded-3xl border-2 border-white/5">
            <h2 id="display-game-name" class="text-2xl font-black text-green-400 italic uppercase truncate mr-4"></h2>
            <button onclick="saveAndExit()" class="bg-green-800 text-white px-6 py-2 rounded-xl font-bold text-xs shadow uppercase whitespace-nowrap hover:bg-green-700">üèÅ Finir & Sauver</button>
        </div>

        <div class="bg-black/40 backdrop-blur-xl rounded-[3.5rem] shadow-2xl overflow-hidden border-2 border-white/5">
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead id="t-head" class="text-[10px] text-slate-400"></thead>
                    <tbody id="t-body"></tbody>
                    <tfoot id="t-foot"></tfoot>
                </table>
            </div>
        </div>
        
        <button onclick="addRound()" class="w-full mt-6 bg-white text-black py-6 rounded-full font-black text-2xl shadow-2xl active:scale-95 transition-all border-b-8 border-slate-300">+ Tour Suivant</button>
    </div>

    <script>
        let players = [];
        let finalGameName = "";

        function addPlayer() {
            const v = document.getElementById('p-input').value.trim().toUpperCase();
            if (v) {
                players.push({ name: v, rounds: [] });
                document.getElementById('p-input').value = "";
                renderChips();
            }
        }

        function renderChips() {
            document.getElementById('chips').innerHTML = players.map((p, i) => `
                <div class="flex items-center bg-green-500/20 text-green-800 px-4 py-2 rounded-xl gap-3 border border-green-500/10">
                    <span class="text-xs font-black">${p.name}</span>
                    <button onclick="players.splice(${i},1);renderChips()" class="text-red-500/70 hover:text-red-500 font-black text-sm">√ó</button>
                </div>
            `).join('');
        }

        function pickStarter() {
            if (players.length === 0) return alert("Ajoute des joueurs d'abord !");
            const winner = players[Math.floor(Math.random() * players.length)].name;
            alert("üé≤ C'est " + winner + " qui commence !");
        }

        function start() {
            finalGameName = document.getElementById('game-name').value.trim() || "Jeu Libre";
            if (players.length === 0) return alert("Ajoute au moins un joueur !");
            
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('display-game-name').innerText = finalGameName;

            let h = `<tr><th class="p-4 text-left text-slate-400">Tour</th>`;
            players.forEach(p => h += `<th class="p-4 border-l border-white/10 text-center font-black text-green-400 uppercase">${p.name}</th>`);
            document.getElementById('t-head').innerHTML = h + `</tr>`;
            
            addRound();
        }

        function addRound() {
            players.forEach(p => p.rounds.push(0));
            renderTable();
        }

        function renderTable() {
            let b = "";
            const rowCount = players[0].rounds.length;
            for (let r = 0; r < rowCount; r++) {
                b += `<tr class="animate-pop border-t border-white/5 table-row-hover"><td class="p-4 text-center font-bold text-slate-500 italic">${r+1}</td>`;
                players.forEach((p, pi) => {
                    b += `<td class="p-2 border-l border-white/10">
                        <input type="number" value="${p.rounds[r]}" 
                            onchange="players[${pi}].rounds[${r}]=parseInt(this.value)||0;renderTable();" 
                            class="score-input w-full text-center text-3xl font-black outline-none bg-transparent focus:bg-green-500/10 rounded-lg transition text-white py-3">
                    </td>`;
                });
                b += `</tr>`;
            }
            document.getElementById('t-body').innerHTML = b;

            let f = `<tr class="bg-black/30"><td class="p-4 font-black uppercase text-xs">Total</td>`;
            players.forEach(p => {
                const tot = p.rounds.reduce((a, b) => a + b, 0);
                f += `<td class="p-4 border-l border-black/20 text-center font-black text-2xl text-yellow-400">${tot}</td>`;
            });
            document.getElementById('t-foot').innerHTML = f + "</tr>";
        }

        async function saveAndExit() {
            if (!confirm("Sauvegarder les scores dans le palmar√®s ?")) return;
            
            let results = players.map(p => ({
                name: p.name,
                score: p.rounds.reduce((a, b) => a + b, 0)
            }));
            
            const winner = [...results].sort((a,b) => b.score - a.score)[0].name;

            const res = { game: finalGameName, date: new Date().toLocaleDateString('fr-FR'), winner: winner, results: results };

            try {
                const response = await fetch('api.php?action=stats');
                let history = await response.json();
                if (!Array.isArray(history)) history = [];
                history.push(res);
                await fetch('api.php?action=stats', { method: 'POST', body: JSON.stringify(h) });
            } catch(e) {
                console.error("Sauvegarde √©chou√©e: ", e);
            } finally {
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>