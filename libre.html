<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autre Jeu - ScoreMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans">

    <div id="setup" class="max-w-md mx-auto mt-12 bg-white p-8 rounded-[2.5rem] shadow-2xl animate-pop">
        <h2 class="text-3xl font-black mb-8 text-orange-500 uppercase italic tracking-tighter text-center">Nouveau Jeu</h2>
        
        <div class="space-y-6">
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Nom du jeu</label>
                <input type="text" id="game-name" placeholder="Ex: Belote, Uno, Tarot..." 
                       class="w-full border-2 p-4 rounded-2xl outline-none focus:border-orange-500 font-bold shadow-sm">
            </div>

            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Ajouter des joueurs</label>
                <div class="flex gap-2">
                    <input type="text" id="p-input" onkeyup="if(event.key === 'Enter') addPlayer()" placeholder="Nom..." 
                           class="flex-1 border-2 p-4 rounded-2xl outline-none focus:border-orange-500 shadow-sm">
                    <button onclick="addPlayer()" class="bg-orange-500 text-white px-6 rounded-2xl font-black shadow-lg">+</button>
                </div>
            </div>

            <div id="chips" class="flex flex-wrap gap-2"></div>

            <div class="grid grid-cols-1 gap-3 pt-4 border-t">
                <button onclick="pickStarter()" class="w-full bg-slate-50 text-gray-500 py-3 rounded-2xl font-bold border-2 border-dashed uppercase text-xs">üé≤ Qui commence ?</button>
                <button onclick="start()" class="w-full bg-black text-white py-5 rounded-3xl font-black uppercase tracking-widest shadow-xl">Cr√©er la grille</button>
            </div>
        </div>
        <a href="index.html" class="block text-center mt-6 text-gray-300 font-bold uppercase text-[10px] tracking-widest">Retour au Hub</a>
    </div>

    <div id="game" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow border-t-4 border-orange-500">
            <h2 id="display-game-name" class="text-2xl font-black text-orange-500 italic uppercase truncate mr-4"></h2>
            <button onclick="saveAndExit()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-xs shadow uppercase whitespace-nowrap">üèÅ Finir & Sauver</button>
        </div>

        <div class="overflow-x-auto bg-white rounded-3xl shadow-xl border">
            <table class="w-full border-collapse">
                <thead id="t-head" class="bg-gray-50 text-xs text-gray-400 uppercase"></thead>
                <tbody id="t-body"></tbody>
                <tfoot id="t-foot" class="bg-gray-900 text-white"></tfoot>
            </table>
        </div>
        
        <button onclick="addRound()" class="w-full mt-6 bg-orange-500 text-white py-5 rounded-3xl font-black text-xl shadow-lg uppercase tracking-widest">+ Tour Suivant</button>
    </div>

    <script>
        let players = [];
        let finalGameName = "";

        function addPlayer() {
            const v = document.getElementById('p-input').value.trim();
            if (v) {
                players.push({ name: v, rounds: [] });
                document.getElementById('p-input').value = "";
                renderChips();
            }
        }

        function renderChips() {
            document.getElementById('chips').innerHTML = players.map((p, i) => `
                <span class="bg-orange-50 text-orange-600 px-4 py-2 rounded-xl font-bold text-xs uppercase flex items-center gap-2">
                    ${p.name} <button onclick="players.splice(${i},1);renderChips()" class="text-red-400 font-black text-sm">√ó</button>
                </span>
            `).join('');
        }

        function pickStarter() {
            if (players.length === 0) return alert("Ajoute des joueurs d'abord !");
            const winner = players[Math.floor(Math.random() * players.length)].name;
            alert("üé≤ C'est " + winner + " qui commence !");
        }

        function start() {
            finalGameName = document.getElementById('game-name').value.trim() || "Autre Jeu";
            if (players.length === 0) return alert("Ajoute au moins un joueur !");
            
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('display-game-name').innerText = finalGameName;

            // Initialiser le header
            let h = `<tr><th class="p-4 text-left">Tour</th>`;
            players.forEach(p => h += `<th class="p-4 border-l text-center font-black text-orange-600 uppercase">${p.name}</th>`);
            document.getElementById('t-head').innerHTML = h + `</tr>`;
            
            addRound();
        }

        function addRound() {
            players.forEach(p => p.rounds.push(0));
            renderTable();
        }

        function renderTable() {
            let b = "";
            const rowCount = players[0].rounds.length;
            for (let r = 0; r < rowCount; r++) {
                b += `<tr class="animate-pop"><td class="p-4 border-b text-center font-bold text-gray-300 italic">${r+1}</td>`;
                players.forEach((p, pi) => {
                    b += `<td class="p-2 border-b border-l">
                        <input type="number" value="${p.rounds[r]}" 
                            onchange="players[${pi}].rounds[${r}]=parseInt(this.value)||0;renderTable();" 
                            class="w-full text-center text-3xl font-black outline-none bg-transparent focus:bg-orange-50 rounded-lg transition">
                    </td>`;
                });
                b += `</tr>`;
            }
            document.getElementById('t-body').innerHTML = b;

            let f = `<tr><td class="p-4 font-black uppercase text-xs">Total</td>`;
            players.forEach(p => {
                const tot = p.rounds.reduce((a, b) => a + b, 0);
                f += `<td class="p-4 border-l text-center font-black text-2xl">${tot}</td>`;
            });
            document.getElementById('t-foot').innerHTML = f + "</tr>";
        }

        async function saveAndExit() {
            if (!confirm("Sauvegarder les scores dans le palmar√®s ?")) return;
            
            // Calcul du gagnant (Plus haut score par d√©faut)
            let results = players.map(p => ({
                name: p.name,
                score: p.rounds.reduce((a, b) => a + b, 0)
            }));
            
            const winner = [...results].sort((a,b) => b.score - a.score)[0].name;

            const res = {
                game: finalGameName,
                date: new Date().toLocaleDateString(),
                winner: winner,
                results: results
            };

            // R√©cup√©rer l'historique et pousser
            const h = await (await fetch('api.php?action=stats')).json();
            h.push(res);
            await fetch('api.php?action=stats', {
                method: 'POST',
                body: JSON.stringify(h)
            });

            location.href = 'index.html';
        }
    </script>
</body>
</html>
