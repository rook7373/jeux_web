<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyjo - ScoreMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans">
    <div id="setup" class="max-w-md mx-auto mt-12 bg-white p-8 rounded-3xl shadow-2xl">
        <h2 class="text-3xl font-black mb-6 text-green-600 uppercase italic">Skyjo Setup</h2>
        <input type="text" id="p-input" placeholder="Nom du joueur..." class="w-full border-2 p-4 rounded-2xl mb-4 outline-none focus:border-green-500">
        <div id="chips" class="flex flex-wrap gap-2 mb-6"></div>
        <button onclick="start()" class="w-full bg-black text-white py-4 rounded-2xl font-black uppercase">Lancer la partie</button>
        <a href="index.html" class="block text-center mt-4 text-gray-400 font-bold">Retour</a>
    </div>

    <div id="game" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow">
            <h2 class="text-2xl font-black text-green-600 italic uppercase">Skyjo</h2>
            <button onclick="saveAndExit()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm">FINIR & SAUVER</button>
        </div>
        <div class="overflow-x-auto bg-white rounded-3xl shadow-xl">
            <table class="w-full border-collapse">
                <thead id="t-head" class="bg-gray-50"></thead>
                <tbody id="t-body"></tbody>
                <tfoot id="t-foot" class="bg-gray-900 text-white"></tfoot>
            </table>
        </div>
        <button onclick="addRound()" class="w-full mt-4 bg-green-500 text-white py-5 rounded-2xl font-black text-xl shadow-lg">+ TOUR SUIVANT</button>
    </div>

    <script>
        let players = [];
        function addPlayer() {
            const v = document.getElementById('p-input').value.trim();
            if(v) { players.push({name:v, rounds:[]}); document.getElementById('p-input').value=""; renderChips(); }
        }
        document.getElementById('p-input').onkeyup = (e) => e.key === 'Enter' && addPlayer();
        function renderChips() {
            document.getElementById('chips').innerHTML = players.map(p => `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold text-xs uppercase">${p.name}</span>`).join('');
        }
        function start() {
            if(players.length === 0) return;
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            let h = `<tr><th class="p-4 text-xs text-gray-400">TOUR</th>`;
            players.forEach(p => h += `<th class="p-4 border-l text-center font-black text-green-600">${p.name}</th>`);
            document.getElementById('t-head').innerHTML = h + `</tr>`;
            addRound();
        }
        function addRound() {
            players.forEach(p => p.rounds.push(0));
            renderTable();
        }
        function renderTable() {
            let b = "";
            for(let r=0; r < players[0].rounds.length; r++) {
                b += `<tr><td class="p-4 border-b text-center font-bold text-gray-300 italic">${r+1}</td>`;
                players.forEach((p, pi) => {
                    b += `<td class="p-2 border-b border-l"><input type="number" value="${p.rounds[r]}" onchange="players[${pi}].rounds[${r}]=parseInt(this.value)||0;renderTable();" class="w-full text-center text-3xl font-black outline-none bg-transparent"></td>`;
                });
                b += `</tr>`;
            }
            document.getElementById('t-body').innerHTML = b;
            let f = `<tr class="bg-gray-900 text-white"><td class="p-4 font-black">TOTAL</td>`;
            players.forEach(p => {
                const tot = p.rounds.reduce((a,b)=>a+b,0);
                f += `<td class="p-4 border-l text-center font-black text-2xl ${tot>=100?'bg-red-600 animate-pulse':''}">${tot}</td>`;
                if(tot >= 100) setTimeout(() => alert(p.name + " a perdu !"), 200);
            });
            document.getElementById('t-foot').innerHTML = f + "</tr>";
        }
        async function saveAndExit() {
            let res = { game: "Skyjo", results: players.map(p => ({name:p.name, score: p.rounds.reduce((a,b)=>a+b,0)})) };
            res.winner = [...res.results].sort((a,b)=>a.score-b.score)[0].name;
            const h = await (await fetch('api.php?action=stats')).json();
            h.push(res);
            await fetch('api.php?action=stats', {method:'POST', body: JSON.stringify(h)});
            location.href='index.html';
        }
    </script>
</body>
</html>
