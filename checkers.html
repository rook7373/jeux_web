<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dames - Arena 51</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: radial-gradient(circle at center, #0a2f1a 0%, #000000 100%);
            color: white;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            max-width: 600px;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 1.5rem;
            overflow: hidden;
        }

        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .light-square { background-color: rgba(255,255,255,0.15); }
        .dark-square { background-color: rgba(0,50,25,0.8); }

        .selected { background-color: rgba(29,255,175,0.4) !important; }
        .highlight-move { background-color: rgba(29,255,175,0.4) !important; }
        .highlight-capture { background-color: rgba(255,200,29,0.5) !important; }

        .piece {
            width: 75%;
            height: 75%;
            border-radius: 50%;
            box-shadow: inset 0 -4px 8px rgba(0,0,0,0.4);
        }

        .color-dot {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            border: 4px solid transparent;
        }

        .color-dot.active {
            border-color: black;
            transform: scale(1.15);
        }
    </style>
</head>

<body class="p-4 flex items-center justify-center uppercase font-black">

<div id="setup" class="bg-white text-black p-8 rounded-3xl max-w-md w-full">
    <h2 class="text-3xl text-center mb-6">DAMES ARENA</h2>

    <div class="mb-6 text-center">
        <p class="text-xs mb-3">COULEUR</p>
        <div class="flex justify-center gap-4">
            <div id="c-red" class="color-dot active" onclick="setColor('red')" style="background:#f87171"></div>
            <div id="c-black" class="color-dot" onclick="setColor('black')" style="background:#60a5fa"></div>
        </div>
    </div>

    <input id="my-name-in" placeholder="TON PSEUDO"
        class="w-full p-4 mb-4 text-center rounded-xl bg-slate-100">

    <button onclick="startGame()" class="w-full bg-black text-white p-4 rounded-xl">
        DÉMARRER
    </button>
</div>

<div id="game" class="hidden max-w-4xl w-full">
    <div class="text-center mb-4" id="players-display"></div>
    <div class="flex justify-center">
        <div id="board"></div>
    </div>
</div>

<script>
const ROWS = 10, COLS = 10;

let myName = "";
let myColor = "red";

let gameState = {
    players: [],
    board: [],
    currentPlayer: "",
    selectedPiece: null,
    possibleMoves: [],
    gameOver: false
};

const initialBoard = [
    ['', 'bp', '', 'bp', '', 'bp', '', 'bp', '', 'bp'],
    ['bp', '', 'bp', '', 'bp', '', 'bp', '', 'bp', ''],
    ['', 'bp', '', 'bp', '', 'bp', '', 'bp', '', 'bp'],
    ['bp', '', 'bp', '', 'bp', '', 'bp', '', 'bp', ''],
    ['', '', '', '', '', '', '', '', '', ''],
    ['', '', '', '', '', '', '', '', '', ''],
    ['', 'rp', '', 'rp', '', 'rp', '', 'rp', '', 'rp'],
    ['rp', '', 'rp', '', 'rp', '', 'rp', '', 'rp', ''],
    ['', 'rp', '', 'rp', '', 'rp', '', 'rp', '', 'rp'],
    ['rp', '', 'rp', '', 'rp', '', 'rp', '', 'rp', '']
];

function setColor(c) {
    myColor = c;
    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
    document.getElementById('c-' + c).classList.add('active');
}

function startGame() {
    myName = document.getElementById('my-name-in').value.trim().toUpperCase();
    if (!myName) return alert("Pseudo requis");

    gameState.board = JSON.parse(JSON.stringify(initialBoard));

    gameState.players = [
        { name: myName, color: myColor },
        { name: "IA", color: myColor === "red" ? "black" : "red" }
    ];

    // ✅ FIX CRITIQUE : le joueur humain commence
    gameState.currentPlayer = gameState.players[0].color;

    document.getElementById('setup').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');

    render();
}

function isOnBoard(r, c) {
    return r >= 0 && r < ROWS && c >= 0 && c < COLS;
}

function getPossibleMoves(row, col) {
    const piece = gameState.board[row][col];
    if (!piece) return [];

    const color = piece[0];
    const enemy = color === 'r' ? 'b' : 'r';
    const moves = [];

    const dirs = color === 'r'
        ? [{dr:-1,dc:-1},{dr:-1,dc:1}]
        : [{dr:1,dc:-1},{dr:1,dc:1}];

    for (const d of dirs) {
        const r1 = row + d.dr;
        const c1 = col + d.dc;
        const r2 = row + 2*d.dr;
        const c2 = col + 2*d.dc;

        if (isOnBoard(r2,c2) && gameState.board[r1][c1]?.startsWith(enemy) && !gameState.board[r2][c2]) {
            moves.push({row:r2,col:c2,isCapture:true,captured:{row:r1,col:c1}});
        } else if (isOnBoard(r1,c1) && !gameState.board[r1][c1]) {
            moves.push({row:r1,col:c1,isCapture:false});
        }
    }

    return moves;
}

function handleSquareClick(r,c) {
    if (gameState.gameOver) return;

    const piece = gameState.board[r][c];

    // ✅ Sécurité : on ne peut cliquer que sur ses pions
    if (piece && !piece.startsWith(gameState.currentPlayer[0])) return;

    if (gameState.selectedPiece) {
        const move = gameState.possibleMoves.find(m => m.row===r && m.col===c);
        if (move) {
            makeMove(gameState.selectedPiece, move);
            gameState.selectedPiece = null;
            gameState.possibleMoves = [];
            gameState.currentPlayer = gameState.currentPlayer === "red" ? "black" : "red";
            render();
            setTimeout(aiMove, 600);
            return;
        }
    }

    if (piece) {
        gameState.selectedPiece = {row:r,col:c};
        gameState.possibleMoves = getPossibleMoves(r,c);
        render();
    }
}

function makeMove(from, to) {
    const piece = gameState.board[from.row][from.col];
    gameState.board[to.row][to.col] = piece;
    gameState.board[from.row][from.col] = '';

    if (to.isCapture) {
        gameState.board[to.captured.row][to.captured.col] = '';
    }
}

function aiMove() {
    if (gameState.currentPlayer !== gameState.players[1].color) return;

    const aiColor = gameState.currentPlayer[0];
    let moves = [];

    for (let r=0;r<ROWS;r++) {
        for (let c=0;c<COLS;c++) {
            if (gameState.board[r][c]?.startsWith(aiColor)) {
                getPossibleMoves(r,c).forEach(m => {
                    moves.push({from:{row:r,col:c},to:m});
                });
            }
        }
    }

    if (!moves.length) return;

    const m = moves[Math.floor(Math.random()*moves.length)];
    makeMove(m.from, m.to);
    gameState.currentPlayer = gameState.players[0].color;
    render();
}

function render() {
    const board = document.getElementById('board');
    board.innerHTML = "";

    for (let r=0;r<ROWS;r++) {
        for (let c=0;c<COLS;c++) {
            const sq = document.createElement('div');
            sq.className = `square ${(r+c)%2?'dark-square':'light-square'}`;
            sq.onclick = () => handleSquareClick(r,c);

            const piece = gameState.board[r][c];
            if (piece) {
                const p = document.createElement('div');
                p.className = 'piece';
                p.style.background = piece[0]==='r' ? '#f87171' : '#60a5fa';
                sq.appendChild(p);
            }

            if (gameState.selectedPiece?.row===r && gameState.selectedPiece?.col===c) {
                sq.classList.add('selected');
            }

            if (gameState.possibleMoves.some(m=>m.row===r && m.col===c)) {
                sq.classList.add('highlight-move');
            }

            board.appendChild(sq);
        }
    }

    document.getElementById('players-display').innerText =
        `${gameState.players[0].name} (${gameState.players[0].color}) VS IA`;
}
</script>

</body>
</html>
