<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yam's Arena LIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: radial-gradient(circle at center, #0a2f1a 0%, #000000 100%); overflow-x: hidden; color: white; min-height: 100vh; }
        
        /* SCÈNE DU DÉ */
        .scene { width: 80px; height: 80px; margin: 12px; perspective: 1000px; position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.15, 0.9, 0.25, 1); }
        .face { position: absolute; width: 80px; height: 80px; background: var(--die-color, #ffffff); border: 1px solid rgba(0,0,0,0.2); border-radius: 14px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 8px; box-sizing: border-box; backface-visibility: hidden; }
        .dot { background: var(--dot-color, #1a1a1a); border-radius: 50%; width: 14px; height: 14px; margin: auto; }
        
        /* AXES DE ROTATION PARFAITS */
        .f1 { transform: rotateY(0deg) translateZ(40px); }
        .f2 { transform: rotateY(-90deg) translateZ(40px); }
        .f3 { transform: rotateX(-90deg) translateZ(40px); }
        .f4 { transform: rotateX(90deg) translateZ(40px); }
        .f5 { transform: rotateY(90deg) translateZ(40px); }
        .f6 { transform: rotateY(180deg) translateZ(40px); }

        /* SURBRILLANCE ULTRA VISIBLE */
        .scene.held { transform: translateY(-25px) scale(1.1); }
        .scene.held .face { 
            border: 4px solid white; 
            box-shadow: 
                0 0 0 4px var(--player-accent),
                0 0 30px var(--player-accent),
                inset 0 0 15px var(--player-accent);
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 15px var(--player-accent), inset 0 0 10px var(--player-accent); }
            50% { box-shadow: 0 0 40px var(--player-accent), inset 0 0 20px var(--player-accent); }
            100% { box-shadow: 0 0 15px var(--player-accent), inset 0 0 10px var(--player-accent); }
        }

        /* SCORES */
        .potential-score { color: #4b5563; font-style: italic; opacity: 0.4; cursor: pointer; font-size: 1.4rem; transition: 0.2s; }
        .potential-score:hover { color: white; opacity: 1; background: rgba(255,255,255,0.05); }
        .locked-score { font-weight: 900; opacity: 1 !important; font-size: 2rem; text-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .total-row { background: rgba(255,255,255,0.08); color: #fbbf24; }
    </style>
</head>
<body class="p-4 font-sans uppercase font-black">

    <div id="setup" class="max-w-md mx-auto mt-10 bg-white p-10 rounded-[3.5rem] text-slate-900 shadow-2xl">
        <h2 class="text-3xl mb-8 text-green-900 text-center italic tracking-tighter">CONFIGURATION</h2>
        <div class="bg-slate-50 p-6 rounded-3xl border mb-6 text-center">
            <input type="text" id="my-name-in" placeholder="TON PSEUDO..." class="w-full bg-white font-black p-4 rounded-2xl border text-center mb-4 outline-none focus:border-green-500 uppercase">
            <div id="color-picker" class="flex justify-center gap-3 mb-4"></div>
        </div>
        <div class="flex gap-3">
            <button onclick="window.location.href='index.html'" class="flex-1 bg-slate-100 text-slate-400 py-5 rounded-2xl text-xs">RETOUR</button>
            <button onclick="joinGame()" class="flex-[2] bg-black text-white py-5 rounded-2xl tracking-widest text-sm">JOUER</button>
        </div>
    </div>

    <div id="game" class="hidden max-w-[98%] mx-auto grid lg:grid-cols-12 gap-8 mt-4">
        <div class="lg:col-span-6 bg-black/40 backdrop-blur-xl p-8 rounded-[4rem] border-4 border-white/5 flex flex-col items-center h-fit">
            <div class="w-full flex justify-between items-center mb-10">
                <button onclick="window.location.href='index.html'" class="text-[10px] bg-white/10 px-5 py-2 rounded-full tracking-widest">MENU</button>
                <div class="px-8 py-3 rounded-full bg-black/40 text-lg tracking-widest border border-white/10 shadow-inner">
                    TOUR : <span id="active-player-name" class="text-white">-</span>
                </div>
                <button onclick="copyLink()" class="text-[10px] bg-green-600 px-5 py-2 rounded-full tracking-widest">COPIER LIEN</button>
            </div>
            
            <div id="dice-row" class="flex justify-center flex-wrap gap-4 mb-20 h-40">
                <div id="d0" onclick="toggleHold(0)" class="scene"><div class="cube" id="cube0"></div></div>
                <div id="d1" onclick="toggleHold(1)" class="scene"><div class="cube" id="cube1"></div></div>
                <div id="d2" onclick="toggleHold(2)" class="scene"><div class="cube" id="cube2"></div></div>
                <div id="d3" onclick="toggleHold(3)" class="scene"><div class="cube" id="cube3"></div></div>
                <div id="d4" onclick="toggleHold(4)" class="scene"><div class="cube" id="cube4"></div></div>
            </div>

            <div class="text-center w-full max-w-sm">
                <p id="roll-count" class="text-sm text-slate-500 mb-6 uppercase tracking-widest">Lancers : 0 / 3</p>
                <button id="roll-btn" onclick="rollDice()" class="bg-white text-slate-900 w-full py-10 rounded-full font-black text-5xl uppercase shadow-2xl active:scale-95 transition-all">LANCER</button>
            </div>
        </div>

        <div class="lg:col-span-6 bg-white/5 backdrop-blur-lg rounded-[4rem] p-8 border border-white/10 shadow-2xl h-fit overflow-x-auto">
            <table class="w-full border-separate border-spacing-y-2">
                <thead><tr id="table-head" class="text-[12px] text-slate-400 uppercase"><th class="text-left pb-4 pr-10">CONTRATS</th></tr></thead>
                <tbody id="table-body" class="font-black"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API = 'api_yams.php';
        let roomId = new URLSearchParams(window.location.search).get('room');
        let myName = '', myColorIdx = 0, players = [], cIdx = 0, rolls = 0, dice = [1,1,1,1,1].map(v=>({v,held:false}));
        
        const colors=[{n:'Ivoire',b:'#fdf8e8',d:'#1a1a1a',a:'#fbbf24'},{n:'Bleu',b:'#3b82f6',d:'#ffffff',a:'#60a5fa'},{n:'Rouge',b:'#ef4444',d:'#ffffff',a:'#f87171'},{n:'Or',b:'#fbbf24',d:'#451a03',a:'#fbbf24'},{n:'Vert',b:'#10b981',d:'#ffffff',a:'#34d399'},{n:'Violet',b:'#8b5cf6',d:'#ffffff',a:'#a78bfa'}];
        const facesHTML=['','<div class="face f1"><div class="dot" style="grid-area:2/2"></div></div>','<div class="face f2"><div class="dot" style="grid-area:1/1"></div><div class="dot" style="grid-area:3/3"></div></div>','<div class="face f3"><div class="dot" style="grid-area:1/1"></div><div class="dot" style="grid-area:2/2"></div><div class="dot" style="grid-area:3/3"></div></div>','<div class="face f4"><div class="dot" style="grid-area:1/1"></div><div class="dot" style="grid-area:1/3"></div><div class="dot" style="grid-area:3/1"></div><div class="dot" style="grid-area:3/3"></div></div>','<div class="face f5"><div class="dot" style="grid-area:1/1"></div><div class="dot" style="grid-area:1/3"></div><div class="dot" style="grid-area:2/2"></div><div class="dot" style="grid-area:3/1"></div><div class="dot" style="grid-area:3/3"></div></div>','<div class="face f6"><div class="dot" style="grid-area:1/1"></div><div class="dot" style="grid-area:2/1"></div><div class="dot" style="grid-area:3/1"></div><div class="dot" style="grid-area:1/3"></div><div class="dot" style="grid-area:2/3"></div><div class="dot" style="grid-area:3/3"></div></div>'];
        const cats=["1","2","3","4","5","6","BONUS (63+)","TOTAL SUP","BRELAN","CARRÉ","FULL","PTE SUITE","GDE SUITE","YAMS","CHANCE","TOTAL GLOBAL"];

        document.getElementById('color-picker').innerHTML = colors.map((c,i)=>`<div onclick="selCol(${i})" class="color-opt" style="background:${c.b}; width:45px; height:45px; border-radius:50%; cursor:pointer; border:3px solid transparent;"></div>`).join('');
        function selCol(i){ myColorIdx=i; document.querySelectorAll('#color-picker div').forEach((o,idx)=>o.style.borderColor = idx===i ? 'black' : 'transparent'); }
        selCol(0);

        async function joinGame() {
            myName = document.getElementById('my-name-in').value.trim();
            if(!myName) return alert("Pseudo !");
            if(!roomId) roomId = Math.random().toString(36).substring(2, 8);
            window.history.pushState({}, '', `?room=${roomId}`);
            await syncPull();
            if(!players.find(p => p.name === myName)) players.push({ name: myName, color: colors[myColorIdx], scores: {} });
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            for(let i=0;i<5;i++) document.getElementById(`cube${i}`).innerHTML=facesHTML.slice(1).join('');
            await syncPush();
            setInterval(syncPull, 1000);
            renderTableStructure();
        }

        async function syncPush() {
            if(!roomId) return;
            const data = { players, cIdx, rolls, dice, roomId };
            await fetch(`${API}?action=sync&roomId=${roomId}`, { method: 'POST', body: JSON.stringify(data) });
        }

        async function syncPull() {
            if(!roomId) return;
            try {
                const r = await fetch(`${API}?action=sync&roomId=${roomId}`);
                const data = await r.json();
                if(data) {
                    // Si c'est un nouveau tour (rolls = 0), on remet les dés à 1 visuellement
                    if(data.rolls === 0 && rolls !== 0) {
                        for(let i=0; i<5; i++) document.getElementById(`cube${i}`).style.transform = `rotateX(0deg) rotateY(0deg)`;
                    } else if(data.rolls !== rolls && data.rolls !== 0 && data.players[data.cIdx].name !== myName) {
                        animateCubes(data.dice);
                    }
                    players = data.players; cIdx = data.cIdx; rolls = data.rolls; dice = data.dice;
                    if(document.getElementById('table-head').children.length !== players.length + 1) renderTableStructure();
                    refreshUI();
                }
            } catch(e) {}
        }

        function refreshUI() {
            if(!players[cIdx]) return;
            const p = players[cIdx], isMyTurn = (p.name === myName);
            document.getElementById('active-player-name').innerText = isMyTurn ? "VOUS" : p.name;
            document.getElementById('active-player-name').style.color = p.color.b;
            document.documentElement.style.setProperty('--die-color', p.color.b);
            document.documentElement.style.setProperty('--dot-color', p.color.d);
            document.documentElement.style.setProperty('--player-accent', p.color.a);
            document.getElementById('roll-btn').style.backgroundColor = p.color.b;
            document.getElementById('roll-btn').style.color = p.color.d;
            document.getElementById('roll-count').innerText = `Lancers : ${rolls} / 3`;
            dice.forEach((d,i) => document.getElementById(`d${i}`).classList.toggle('held', d.held));
            renderScores();
            document.getElementById('roll-btn').disabled = (!isMyTurn || rolls >= 3);
            document.getElementById('roll-btn').style.opacity = (!isMyTurn || rolls >= 3) ? "0.1" : "1";
        }

        function renderTableStructure() {
            const h = document.getElementById('table-head');
            h.innerHTML = '<th class="text-left pb-4 pr-10">CONTRATS</th>';
            players.forEach(p => h.innerHTML += `<th class="px-8 text-center text-xl" style="color:${p.color.b}">${p.name}</th>`);
            document.getElementById('table-body').innerHTML = cats.map(c => {
                const isCalc = ["BONUS (63+)", "TOTAL SUP", "TOTAL GLOBAL"].includes(c);
                return `<tr class="border-b border-white/5 ${isCalc ? 'total-row' : ''}">
                    <td class="py-5 pr-10 font-bold text-slate-500 uppercase text-[12px] tracking-widest">${c}</td>
                    ${players.map((p,pi) => `<td onclick="lock('${c}', ${pi})" id="s-${pi}-${c}" class="text-center font-black px-8">-</td>`).join('')}
                </tr>`;
            }).join('');
        }

        function renderScores() {
            players.forEach((p, pi) => {
                let sumSup = 0;
                ["1","2","3","4","5","6"].forEach(k => sumSup += (p.scores[k] || 0));
                const bonus = sumSup >= 63 ? 35 : 0;
                const totalSup = sumSup + bonus;
                let sumInf = 0;
                ["BRELAN","CARRÉ","FULL","PTE SUITE","GDE SUITE","YAMS","CHANCE"].forEach(k => sumInf += (p.scores[k] || 0));
                const totalGlobal = totalSup + sumInf;
                cats.forEach(c => {
                    const cell = document.getElementById(`s-${pi}-${c}`);
                    if(!cell) return;
                    if(c === "BONUS (63+)") cell.innerText = bonus;
                    else if(c === "TOTAL SUP") cell.innerText = totalSup;
                    else if(c === "TOTAL GLOBAL") cell.innerText = totalGlobal;
                    else if(p.scores[c] !== undefined) {
                        cell.innerText = p.scores[c];
                        cell.className = "text-center locked-score px-8";
                        cell.style.color = p.color.b;
                    } else if (pi === cIdx && p.name === myName && rolls > 0) {
                        cell.innerText = calculatePotential(c);
                        cell.className = "text-center potential-score px-8";
                        cell.style.color = "";
                    } else {
                        cell.innerText = "-";
                        cell.className = "text-center px-8";
                        cell.style.color = "";
                    }
                });
            });
        }

        function calculatePotential(c) {
            const vals = dice.map(d=>d.v), counts = {}; vals.forEach(v=>counts[v]=(counts[v]||0)+1);
            const sum = vals.reduce((a,b)=>a+b,0);
            if(!isNaN(c)) return (counts[c] || 0) * parseInt(c);
            if(c=="BRELAN") return Object.values(counts).some(v => v >= 3) ? sum : 0;
            if(c=="CARRÉ") return Object.values(counts).some(v => v >= 4) ? sum : 0;
            if(c=="FULL") return (Object.values(counts).includes(3) && Object.values(counts).includes(2)) ? 25 : 0;
            if(c=="PTE SUITE") return isSuite(vals, 4) ? 30 : 0;
            if(c=="GDE SUITE") return isSuite(vals, 5) ? 40 : 0;
            if(c=="YAMS") return Object.values(counts).includes(5) ? 50 : 0;
            if(c=="CHANCE") return sum;
            return 0;
        }

        function isSuite(a,l){const s=[...new Set(a)].sort();let c=1,m=1;for(let i=0;i<s.length-1;i++){s[i+1]==s[i]+1?c++:c=1;m=Math.max(m,c)}return m>=l}

        function toggleHold(i) {
            if(rolls === 0 || players[cIdx].name !== myName) return;
            dice[i].held = !dice[i].held;
            document.getElementById(`d${i}`).classList.toggle('held', dice[i].held);
            syncPush(); 
        }

        async function lock(c, pi) {
            if(pi !== cIdx || players[pi].name !== myName || rolls === 0 || players[pi].scores[c] !== undefined || ["BONUS (63+)", "TOTAL SUP", "TOTAL GLOBAL"].includes(c)) return;
            players[pi].scores[c] = calculatePotential(c);
            rolls = 0; dice.forEach(d => { d.held = false; d.v = 1; });
            cIdx = (cIdx + 1) % players.length;
            // On remet les dés à zéro physiquement
            for(let i=0; i<5; i++) {
                document.getElementById(`cube${i}`).style.transform = `rotateX(0deg) rotateY(0deg)`;
                document.getElementById(`d${i}`).classList.remove('held');
            }
            await syncPush();
        }
        function animateCubes(newDice) {
            newDice.forEach((d, i) => {
                if(!dice[i].held) {
                    const cube = document.getElementById(`cube${i}`);
            
                    // On augmente la base à 2880 (8 tours) ou 3600 (10 tours)
                    // On ajoute un petit décalage aléatoire de tours complets (0, 360 ou 720) 
                    // pour que les dés ne s'arrêtent pas tous exactement en même temps
                    let extraSpins = Math.floor(Math.random() * 3) * 360;
                    let xDeg = 2880 + extraSpins;
                    let yDeg = 2880 + extraSpins;

                    // Mapping précis pour les faces (reste inchangé pour la précision)
                    if(d.v===1) { xDeg += 0;   yDeg += 0; }
                    if(d.v===2) { xDeg += 0;   yDeg += 90; }
                    if(d.v===3) { xDeg += 90;  yDeg += 0; }
                    if(d.v===4) { xDeg += -90; yDeg += 0; }
                    if(d.v===5) { xDeg += 0;   yDeg += -90; }
                    if(d.v===6) { xDeg += 0;   yDeg += 180; }

                   cube.style.transform = `rotateX(${xDeg}deg) rotateY(${yDeg}deg)`;
                }
            });
        }
        

        

        function rollDice() {
            if(rolls >= 3 || players[cIdx].name !== myName) return;
            rolls++; dice.forEach(d => { if(!d.held) d.v = Math.floor(Math.random()*6)+1; });
            animateCubes(dice); syncPush();
        }
        function copyLink() { navigator.clipboard.writeText(window.location.href); alert("Lien copié !"); }
    </script>
</body>
</html>